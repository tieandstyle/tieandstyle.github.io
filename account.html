<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>My Account - Tie Style</title>
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#df20df"/>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#df20df",
                    "background-light": "#f8f6f8",
                    "background-dark": "#211121",
                },
                fontFamily: {
                    "display": ["Plus Jakarta Sans", "sans-serif"]
                }
            },
        },
    }
</script>
<style>
.step-done { background-color: #22c55e; }
.step-current { background-color: #df20df; animation: pulse 2s infinite; }
.step-pending { background-color: #e5e7eb; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
</style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-black dark:text-white min-h-screen">

<!-- Header -->
<header class="bg-white dark:bg-background-dark border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10">
  <div class="container mx-auto px-4 py-4 flex items-center justify-between">
    <a href="index.html" class="flex items-center gap-2">
      <img src="image/navlogo.png" alt="Tie Style" class="h-10"/>
      <span class="font-bold text-xl text-primary">Tie Style</span>
    </a>
    <div class="flex items-center gap-4">
      <a href="index.html" class="text-sm hover:text-primary">Shop</a>
      <button id="logoutBtn" onclick="handleLogout()" class="hidden text-red-500 hover:underline text-sm">Logout</button>
    </div>
  </div>
</header>

<main class="container mx-auto px-4 py-8 max-w-4xl">
  
  <!-- Login/Register Section -->
  <div id="authSection" class="max-w-md mx-auto">
    <div class="bg-white dark:bg-background-dark border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-lg">
      
      <!-- Tabs -->
      <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
        <button id="loginTabBtn" onclick="showTab('login')" class="flex-1 pb-3 font-medium border-b-2 border-primary text-primary">Login</button>
        <button id="registerTabBtn" onclick="showTab('register')" class="flex-1 pb-3 font-medium border-b-2 border-transparent text-gray-500">Register</button>
      </div>
      
      <!-- Login Form -->
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <input type="email" id="loginEmail" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-background-dark"/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Password</label>
          <input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-background-dark"/>
        </div>
        <button type="submit" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-primary/90 transition">
          üîê Login
        </button>
        <p class="text-center text-sm">
          <a href="#" onclick="showForgotPassword()" class="text-primary hover:underline">Forgot Password?</a>
        </p>
      </form>
      
      <!-- Register Form -->
      <form id="registerForm" class="hidden space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Full Name</label>
          <input type="text" id="registerName" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-background-dark"/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Phone</label>
          <input type="tel" id="registerPhone" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-background-dark" placeholder="+91XXXXXXXXXX"/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <input type="email" id="registerEmail" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-background-dark"/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Password (min 6 chars)</label>
          <input type="password" id="registerPassword" required minlength="6" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-background-dark"/>
        </div>
        <button type="submit" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-primary/90 transition">
          ‚ú® Create Account
        </button>
      </form>
      
      <!-- OR Divider -->
      <div class="flex items-center gap-3 my-4">
        <div class="flex-1 h-px bg-gray-300 dark:bg-gray-600"></div>
        <span class="text-sm text-gray-500">or</span>
        <div class="flex-1 h-px bg-gray-300 dark:bg-gray-600"></div>
      </div>
      
      <!-- Google Sign In -->
      <button type="button" onclick="handleGoogleSignIn()" class="w-full flex items-center justify-center gap-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-white font-medium py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
        <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Continue with Google
      </button>
      
      <p id="authError" class="text-red-500 text-sm mt-3 hidden text-center"></p>
      <p id="authSuccess" class="text-green-500 text-sm mt-3 hidden text-center"></p>
    </div>
    
    <!-- Quick Lookup Section -->
    <div class="bg-white dark:bg-background-dark border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-lg mt-6">
      <h3 class="font-bold text-center mb-4">üì± New Device? Find Your Orders</h3>
      <p class="text-sm text-gray-500 text-center mb-4">Enter your phone or email used while ordering</p>
      
      <form id="quickLookupForm" class="space-y-4">
        <div>
          <input type="text" id="lookupInput" required 
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-background-dark text-center" 
            placeholder="Phone number or Email"/>
        </div>
        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition">
          üîç Find My Orders
        </button>
      </form>
      <p id="lookupError" class="text-red-500 text-sm mt-3 hidden text-center"></p>
    </div>
  </div>

  <!-- Account Dashboard (shown when logged in) -->
  <div id="accountSection" class="hidden space-y-6">
    
    <!-- Welcome Header -->
    <div class="bg-gradient-to-r from-primary to-purple-600 text-white rounded-xl p-6">
      <h1 class="text-2xl font-bold">üëã Welcome, <span id="userName">Customer</span>!</h1>
      <p class="text-white/80 mt-1" id="userEmail">email@example.com</p>
    </div>
    
    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
      <div class="bg-white dark:bg-background-dark border rounded-lg p-4 text-center">
        <p class="text-2xl font-bold text-primary" id="totalOrders">0</p>
        <p class="text-sm text-gray-500">Total Orders</p>
      </div>
      <div class="bg-white dark:bg-background-dark border rounded-lg p-4 text-center">
        <p class="text-2xl font-bold text-green-600" id="totalSpent">‚Çπ0</p>
        <p class="text-sm text-gray-500">Total Spent</p>
      </div>
      <div class="bg-white dark:bg-background-dark border rounded-lg p-4 text-center col-span-2 md:col-span-1">
        <p class="text-2xl font-bold text-orange-500" id="pendingCount">0</p>
        <p class="text-sm text-gray-500">Active Orders</p>
      </div>
    </div>
    
    <!-- Orders Section -->
    <div class="bg-white dark:bg-background-dark border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h2 class="text-lg font-bold">üì¶ My Orders</h2>
        <a href="index.html" class="text-primary text-sm hover:underline">+ Shop More</a>
      </div>
      
      <div id="ordersList" class="divide-y divide-gray-200 dark:divide-gray-700">
        <div class="p-6 text-center text-gray-500">Loading your orders...</div>
      </div>
    </div>
  </div>

</main>

<script type="module">
import { 
  auth, 
  onAuthStateChanged, 
  registerCustomer, 
  loginCustomer, 
  logoutCustomer,
  getCustomerProfile,
  getCustomerOrders,
  signInWithGoogle
} from './js/firebase-config.js';

const ORDER_STATUSES = ['pending', 'processing', 'packed', 'dispatched', 'in-transit', 'out-for-delivery', 'delivered'];
const STATUS_LABELS = {
  'pending': 'üìù Pending',
  'processing': '‚öôÔ∏è Processing',
  'packed': 'üì¶ Packed',
  'dispatched': 'üöö Dispatched',
  'in-transit': 'üõ£Ô∏è In Transit',
  'out-for-delivery': 'üèÉ Out for Delivery',
  'delivered': '‚úÖ Delivered',
  'cancelled': '‚ùå Cancelled'
};

let currentUser = null;

// Auth state listener
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('accountSection').classList.remove('hidden');
    document.getElementById('logoutBtn').classList.remove('hidden');
    await loadUserData(user);
  } else {
    currentUser = null;
    document.getElementById('authSection').classList.remove('hidden');
    document.getElementById('accountSection').classList.add('hidden');
    document.getElementById('logoutBtn').classList.add('hidden');
  }
});

async function loadUserData(user) {
  // Set basic info
  document.getElementById('userEmail').textContent = user.email;
  
  // Get profile
  const profileResult = await getCustomerProfile(user.uid);
  if (profileResult.success) {
    document.getElementById('userName').textContent = profileResult.customer.name || 'Customer';
  }
  
  // Get orders
  const ordersResult = await getCustomerOrders(user.email, null);
  if (ordersResult.success) {
    displayOrders(ordersResult.orders);
    updateStats(ordersResult.orders);
  }
}

function updateStats(orders) {
  document.getElementById('totalOrders').textContent = orders.length;
  
  const totalSpent = orders.reduce((sum, o) => sum + (o.totals?.grandTotal || o.totals?.total || 0), 0);
  document.getElementById('totalSpent').textContent = `‚Çπ${totalSpent.toLocaleString()}`;
  
  const activeOrders = orders.filter(o => !['delivered', 'cancelled'].includes(o.status)).length;
  document.getElementById('pendingCount').textContent = activeOrders;
}

function displayOrders(orders) {
  const container = document.getElementById('ordersList');
  
  if (orders.length === 0) {
    container.innerHTML = `
      <div class="p-8 text-center">
        <p class="text-gray-500 mb-4">No orders yet!</p>
        <a href="index.html" class="bg-primary text-white px-6 py-2 rounded-lg inline-block">üõçÔ∏è Start Shopping</a>
      </div>
    `;
    return;
  }
  
  container.innerHTML = orders.map(order => {
    const date = order.createdAt?.toDate 
      ? order.createdAt.toDate().toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })
      : 'N/A';
    const total = order.totals?.grandTotal || order.totals?.total || 0;
    const status = order.status || 'pending';
    const statusLabel = STATUS_LABELS[status] || status;
    const itemCount = order.items?.length || 0;
    
    // Progress indicator
    const statusIndex = ORDER_STATUSES.indexOf(status);
    const progressPercent = status === 'cancelled' ? 0 : (statusIndex >= 0 ? ((statusIndex + 1) / ORDER_STATUSES.length) * 100 : 10);
    
    return `
      <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer" onclick="toggleOrderDetails('${order.id}')">
        <div class="flex justify-between items-start mb-3">
          <div>
            <p class="font-bold">${order.orderId || order.id}</p>
            <p class="text-sm text-gray-500">${date} ‚Ä¢ ${itemCount} item${itemCount > 1 ? 's' : ''}</p>
          </div>
          <div class="text-right">
            <p class="font-bold">‚Çπ${total}</p>
            <span class="text-xs px-2 py-1 rounded-full ${status === 'delivered' ? 'bg-green-100 text-green-700' : status === 'cancelled' ? 'bg-red-100 text-red-700' : 'bg-primary/10 text-primary'}">
              ${statusLabel}
            </span>
          </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
          <div class="h-full ${status === 'delivered' ? 'bg-green-500' : status === 'cancelled' ? 'bg-red-500' : 'bg-primary'} transition-all duration-500" style="width: ${progressPercent}%"></div>
        </div>
        
        <!-- Order Details (hidden by default) -->
        <div id="details-${order.id}" class="hidden mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
          <p class="text-sm font-medium mb-2">Items:</p>
          ${(order.items || []).map(item => `
            <div class="flex items-center gap-3 py-2">
              <img src="${item.image || 'image/placeholder.jpg'}" class="w-12 h-12 rounded object-cover" onerror="this.src='image/placeholder.jpg'"/>
              <div class="flex-grow">
                <p class="text-sm font-medium">${item.title}</p>
                <p class="text-xs text-gray-500">Qty: ${item.quantity} √ó ‚Çπ${item.price}</p>
              </div>
            </div>
          `).join('')}
          ${order.customer?.address || order.customer?.addressLine1 ? `
            <p class="text-sm font-medium mt-3 mb-1">Delivery Address:</p>
            <p class="text-sm text-gray-500">${order.customer?.address || order.customer?.addressLine1}, ${order.customer?.city}, ${order.customer?.state} - ${order.customer?.zip || order.customer?.postalCode}</p>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

window.toggleOrderDetails = function(orderId) {
  const details = document.getElementById(`details-${orderId}`);
  details.classList.toggle('hidden');
};

window.showTab = function(tab) {
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const loginTab = document.getElementById('loginTabBtn');
  const registerTab = document.getElementById('registerTabBtn');
  
  if (tab === 'login') {
    loginForm.classList.remove('hidden');
    registerForm.classList.add('hidden');
    loginTab.classList.add('border-primary', 'text-primary');
    loginTab.classList.remove('border-transparent', 'text-gray-500');
    registerTab.classList.remove('border-primary', 'text-primary');
    registerTab.classList.add('border-transparent', 'text-gray-500');
  } else {
    loginForm.classList.add('hidden');
    registerForm.classList.remove('hidden');
    registerTab.classList.add('border-primary', 'text-primary');
    registerTab.classList.remove('border-transparent', 'text-gray-500');
    loginTab.classList.remove('border-primary', 'text-primary');
    loginTab.classList.add('border-transparent', 'text-gray-500');
  }
  
  document.getElementById('authError').classList.add('hidden');
  document.getElementById('authSuccess').classList.add('hidden');
};

window.showForgotPassword = function() {
  const email = prompt('Enter your email to reset password:');
  if (email) {
    import('./js/firebase-config.js').then(async ({ resetPassword }) => {
      const result = await resetPassword(email);
      if (result.success) {
        alert('Password reset email sent! Check your inbox.');
      } else {
        alert('Error: ' + result.error);
      }
    });
  }
};

window.handleLogout = async function() {
  const result = await logoutCustomer();
  if (result.success) {
    window.location.reload();
  }
};

window.handleGoogleSignIn = async function() {
  const errorEl = document.getElementById('authError');
  errorEl.classList.add('hidden');
  
  const result = await signInWithGoogle();
  
  if (!result.success) {
    errorEl.textContent = result.error.includes('popup-closed') 
      ? 'Sign-in popup was closed' 
      : result.error;
    errorEl.classList.remove('hidden');
  }
};

// Login form
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const errorEl = document.getElementById('authError');
  
  errorEl.classList.add('hidden');
  
  const result = await loginCustomer(email, password);
  
  if (!result.success) {
    errorEl.textContent = result.error.includes('invalid') ? 'Invalid email or password' : result.error;
    errorEl.classList.remove('hidden');
  }
});

// Register form
document.getElementById('registerForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const name = document.getElementById('registerName').value;
  const phone = document.getElementById('registerPhone').value;
  const email = document.getElementById('registerEmail').value;
  const password = document.getElementById('registerPassword').value;
  const errorEl = document.getElementById('authError');
  const successEl = document.getElementById('authSuccess');
  
  errorEl.classList.add('hidden');
  successEl.classList.add('hidden');
  
  const result = await registerCustomer(email, password, name, phone);
  
  if (result.success) {
    successEl.textContent = '‚úÖ Account created! Loading your dashboard...';
    successEl.classList.remove('hidden');
  } else {
    errorEl.textContent = result.error.includes('email-already') ? 'Email already registered' : result.error;
    errorEl.classList.remove('hidden');
  }
});

// Quick Lookup form - find orders by phone/email without login
document.getElementById('quickLookupForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const lookupValue = document.getElementById('lookupInput').value.trim();
  const errorEl = document.getElementById('lookupError');
  
  errorEl.classList.add('hidden');
  
  if (!lookupValue) {
    errorEl.textContent = 'Please enter your phone number or email';
    errorEl.classList.remove('hidden');
    return;
  }
  
  // Determine if it's email or phone
  const isEmail = lookupValue.includes('@');
  
  try {
    const result = await getCustomerOrders(
      isEmail ? lookupValue : null, 
      isEmail ? null : lookupValue
    );
    
    if (result.success && result.orders.length > 0) {
      // Store lookup info temporarily
      window.lookupUser = {
        identifier: lookupValue,
        isEmail: isEmail
      };
      
      // Hide auth section, show orders
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('accountSection').classList.remove('hidden');
      
      // Update header for guest user
      document.getElementById('userName').textContent = 'Guest';
      document.getElementById('userEmail').textContent = lookupValue;
      
      // Display orders
      displayOrders(result.orders);
      updateStats(result.orders);
    } else {
      errorEl.textContent = 'No orders found with this phone/email. Try with a different one.';
      errorEl.classList.remove('hidden');
    }
  } catch (error) {
    console.error('Lookup error:', error);
    errorEl.textContent = 'Error searching orders. Please try again.';
    errorEl.classList.remove('hidden');
  }
});
</script>
</body>
</html>
